<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mini Gestor de Proyectos - Retry + Cache-Aside + Queue Load Leveling</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary: #1e40af;
                --primary-light: #3b82f6;
                --success: #059669;
                --danger: #dc2626;
                --warning: #d97706;
                --info: #0284c7;
                --dark: #111827;
                --gray-50: #f9fafb;
                --gray-100: #f3f4f6;
                --gray-200: #e5e7eb;
                --gray-300: #d1d5db;
                --gray-400: #9ca3af;
                --gray-500: #6b7280;
                --gray-600: #4b5563;
                --gray-700: #374151;
                --gray-800: #1f2937;
                --gray-900: #111827;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: var(--gray-100);
                min-height: 100vh;
                color: var(--gray-900);
                line-height: 1.6;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                background: white;
                border-bottom: 3px solid var(--primary);
                padding: 24px 32px;
                margin-bottom: 24px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .header h1 {
                color: var(--gray-900);
                font-size: 1.875rem;
                font-weight: 700;
                margin-bottom: 8px;
            }

            .header p {
                color: var(--gray-600);
                font-size: 1rem;
            }

            .dashboard {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 24px;
                margin-bottom: 24px;
            }

            .card {
                background: white;
                border: 1px solid var(--gray-200);
                padding: 24px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .card h2 {
                color: var(--gray-900);
                margin-bottom: 20px;
                font-size: 1.25rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                padding-bottom: 12px;
                border-bottom: 2px solid var(--gray-200);
            }

            .health-status {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 16px;
            }

            .health-item {
                background: var(--gray-50);
                padding: 16px;
                border-left: 3px solid var(--gray-300);
            }

            .health-item.success {
                border-left-color: var(--success);
            }

            .health-item.warning {
                border-left-color: var(--warning);
            }

            .health-item label {
                display: block;
                font-size: 0.8125rem;
                color: var(--gray-600);
                margin-bottom: 6px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .health-item .value {
                font-size: 1.125rem;
                font-weight: 600;
                color: var(--gray-900);
            }

            .btn {
                background: var(--primary);
                color: white;
                border: none;
                padding: 10px 20px;
                font-size: 0.9375rem;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn:hover {
                background: var(--primary-light);
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-success {
                background: var(--success);
            }

            .btn-success:hover {
                background: #047857;
            }

            .btn-danger {
                background: var(--danger);
            }

            .btn-danger:hover {
                background: #b91c1c;
            }

            .btn-sm {
                padding: 6px 12px;
                font-size: 0.875rem;
            }

            .tabs {
                display: flex;
                gap: 0;
                margin-bottom: 24px;
                border-bottom: 2px solid var(--gray-200);
                background: white;
            }

            .tab {
                padding: 12px 24px;
                background: transparent;
                border: none;
                font-size: 0.9375rem;
                font-weight: 500;
                cursor: pointer;
                color: var(--gray-600);
                border-bottom: 3px solid transparent;
                transition: all 0.2s;
            }

            .tab:hover {
                color: var(--gray-900);
                background: var(--gray-50);
            }

            .tab.active {
                color: var(--primary);
                border-bottom-color: var(--primary);
                background: white;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                display: block;
                margin-bottom: 6px;
                font-weight: 500;
                color: var(--gray-700);
                font-size: 0.9375rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--gray-300);
                font-size: 0.9375rem;
                transition: border-color 0.2s;
                font-family: inherit;
            }

            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: var(--primary);
            }

            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .log-container {
                background: var(--gray-900);
                padding: 16px;
                max-height: 500px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 0.8125rem;
            }

            .log-entry {
                margin-bottom: 8px;
                padding: 8px;
                border-left: 3px solid var(--gray-700);
            }

            .log-entry.info {
                border-left-color: var(--info);
                color: #93c5fd;
            }

            .log-entry.success {
                border-left-color: var(--success);
                color: #86efac;
            }

            .log-entry.error {
                border-left-color: var(--danger);
                color: #fca5a5;
            }

            .log-entry.warning {
                border-left-color: var(--warning);
                color: #fcd34d;
            }

            .log-timestamp {
                color: var(--gray-400);
                font-size: 0.75rem;
                margin-right: 8px;
            }

            .data-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 16px;
            }

            .data-table th {
                background: var(--gray-50);
                padding: 12px;
                text-align: left;
                font-weight: 600;
                color: var(--gray-700);
                border-bottom: 2px solid var(--gray-200);
                font-size: 0.875rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .data-table td {
                padding: 12px;
                border-bottom: 1px solid var(--gray-200);
                font-size: 0.9375rem;
            }

            .data-table tr:hover {
                background: var(--gray-50);
            }

            .badge {
                display: inline-block;
                padding: 4px 10px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .badge-success {
                background: #d1fae5;
                color: #065f46;
            }

            .badge-warning {
                background: #fef3c7;
                color: #92400e;
            }

            .badge-info {
                background: #dbeafe;
                color: #1e40af;
            }

            .badge-danger {
                background: #fee2e2;
                color: #991b1b;
            }

            .demo-actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 12px;
                margin-top: 16px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
                margin-bottom: 16px;
            }

            .stat-card {
                background: var(--gray-50);
                border-left: 4px solid var(--primary);
                padding: 20px;
                text-align: center;
            }

            .stat-card h3 {
                font-size: 2.25rem;
                color: var(--primary);
                margin-bottom: 4px;
                font-weight: 700;
            }

            .stat-card p {
                font-size: 0.875rem;
                color: var(--gray-600);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            @media (max-width: 768px) {
                .dashboard {
                    grid-template-columns: 1fr;
                }

                .health-status {
                    grid-template-columns: 1fr;
                }

                .stats-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üõ°Ô∏è Mini Gestor de Proyectos - Patrones de Arquitectura</h1>
                <p>
                    Sistema con Retry, Cache-Aside, Queue-Based Load Leveling, Gatekeeper y Federated Identity ‚Ä¢ Alta
                    disponibilidad, rendimiento y seguridad
                </p>
            </div>

            <!-- Dashboard -->
            <div class="dashboard">
                <!-- Health Check Card -->
                <div class="card">
                    <h2>üè• Health Check</h2>
                    <div class="health-status" id="healthStatus">
                        <div class="health-item">
                            <label>Estado del Sistema</label>
                            <div class="value" id="systemStatus">-</div>
                        </div>
                        <div class="health-item">
                            <label>Base de Datos</label>
                            <div class="value" id="dbStatus">-</div>
                        </div>
                        <div class="health-item">
                            <label>Tiempo de Respuesta</label>
                            <div class="value" id="responseTime">-</div>
                        </div>
                        <div class="health-item">
                            <label>Pool de Conexiones</label>
                            <div class="value" id="poolInfo">-</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="checkHealth()">Verificar Estado</button>
                </div>

                <!-- Stats Card -->
                <div class="card">
                    <h2>üìä Estad√≠sticas</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="userCount">0</h3>
                            <p>Usuarios</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="projectCount">0</h3>
                            <p>Proyectos</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="taskCount">0</h3>
                            <p>Tareas</p>
                        </div>
                    </div>
                    <button class="btn" onclick="updateStats()">Actualizar Estad√≠sticas</button>
                </div>
            </div>

            <!-- Cache Stats Dashboard -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 24px">
                <div class="card">
                    <h2>üíæ Estad√≠sticas de Cach√© (Redis - Cache-Aside)</h2>
                    <div class="health-status" id="cacheStatus">
                        <div class="health-item">
                            <label>Estado de Redis</label>
                            <div class="value" id="cacheAvailable">-</div>
                        </div>
                        <div class="health-item">
                            <label>Total de Claves</label>
                            <div class="value" id="cacheKeys">-</div>
                        </div>
                        <div class="health-item">
                            <label>Cache Hits</label>
                            <div class="value" id="cacheHits">-</div>
                        </div>
                        <div class="health-item">
                            <label>Cache Misses</label>
                            <div class="value" id="cacheMisses">-</div>
                        </div>
                        <div class="health-item">
                            <label>Hit Rate</label>
                            <div class="value" id="cacheHitRate">-</div>
                        </div>
                        <div class="health-item">
                            <label>Memoria Usada</label>
                            <div class="value" id="cacheMemory">-</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="checkCacheStats()">
                        Actualizar Estad√≠sticas de Cach√©
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('demo')">üé¨ Demo Autom√°tica</button>
                    <button class="tab" onclick="switchTab('auth')">üîê Seguridad (Gatekeeper + LDAP)</button>
                    <button class="tab" onclick="switchTab('proyectos')">üìã Proyectos</button>
                    <button class="tab" onclick="switchTab('tareas')">‚úÖ Tareas</button>
                    <button class="tab" onclick="switchTab('queue')">‚ö° Queue Load Leveling</button>
                    <button class="tab" onclick="switchTab('cache')">üíæ Cache-Aside</button>
                    <button class="tab" onclick="switchTab('retry')">üîÑ Sistema Retry</button>
                </div>

                <!-- Autenticaci√≥n y Seguridad Tab -->
                <div id="auth" class="tab-content">
                    <h2>üîê Gatekeeper + Federated Identity (LDAP)</h2>
                    <p style="margin-bottom: 20px; color: var(--gray-600)">
                        Sistema de autenticaci√≥n delegada a LDAP con control de acceso centralizado (API Gateway)
                    </p>

                    <!-- Estado de Autenticaci√≥n -->
                    <div
                        style="
                            background: var(--gray-50);
                            padding: 20px;
                            border-left: 4px solid var(--primary);
                            margin-bottom: 30px;
                        "
                    >
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üë§ Estado de Autenticaci√≥n
                        </h3>
                        <div id="authState">
                            <div style="color: var(--gray-600)">No autenticado. Por favor inicia sesi√≥n.</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px">
                        <!-- Login LDAP -->
                        <div>
                            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                                üîë Login con LDAP
                            </h3>
                            <div style="background: white; border: 1px solid var(--gray-200); padding: 20px">
                                <div class="form-group">
                                    <label>Usuario LDAP</label>
                                    <input type="text" id="ldapUsername" placeholder="admin" />
                                </div>
                                <div class="form-group">
                                    <label>Contrase√±a</label>
                                    <input type="password" id="ldapPassword" placeholder="admin_password" />
                                </div>
                                <button
                                    class="btn btn-success"
                                    style="width: 100%; margin-bottom: 10px"
                                    onclick="loginLDAP()"
                                >
                                    üîê Iniciar Sesi√≥n
                                </button>
                                <button class="btn btn-danger" style="width: 100%" onclick="logout()">
                                    üö™ Cerrar Sesi√≥n
                                </button>
                            </div>

                            <!-- Usuarios de Prueba -->
                            <div
                                style="
                                    background: #dbeafe;
                                    border: 1px solid #3b82f6;
                                    padding: 15px;
                                    border-radius: 6px;
                                    margin-top: 15px;
                                "
                            >
                                <h4 style="color: #1e40af; margin-bottom: 10px; font-size: 0.95rem">
                                    üë• Usuarios de Prueba
                                </h4>
                                <div style="font-size: 0.85rem; color: #1e40af; line-height: 1.8">
                                    <div style="margin-bottom: 8px">
                                        <strong>admin</strong>
                                        / admin_password
                                        <span
                                            style="
                                                background: #10b981;
                                                color: white;
                                                padding: 2px 6px;
                                                border-radius: 3px;
                                                font-size: 0.75rem;
                                                margin-left: 5px;
                                            "
                                        >
                                            ADMIN
                                        </span>
                                    </div>
                                    <div style="margin-bottom: 8px">
                                        <strong>manager</strong>
                                        / manager_password
                                        <span
                                            style="
                                                background: #f59e0b;
                                                color: white;
                                                padding: 2px 6px;
                                                border-radius: 3px;
                                                font-size: 0.75rem;
                                                margin-left: 5px;
                                            "
                                        >
                                            MANAGER
                                        </span>
                                    </div>
                                    <div>
                                        <strong>developer</strong>
                                        / developer_password
                                        <span
                                            style="
                                                background: #6366f1;
                                                color: white;
                                                padding: 2px 6px;
                                                border-radius: 3px;
                                                font-size: 0.75rem;
                                                margin-left: 5px;
                                            "
                                        >
                                            DEV
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n del Usuario -->
                        <div>
                            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                                üìã Informaci√≥n del Usuario
                            </h3>
                            <div
                                id="userInfo"
                                style="
                                    background: white;
                                    border: 1px solid var(--gray-200);
                                    padding: 20px;
                                    min-height: 200px;
                                "
                            >
                                <p style="color: var(--gray-500); text-align: center; padding: 40px 0">
                                    No hay sesi√≥n activa
                                </p>
                            </div>

                            <div style="margin-top: 15px">
                                <button class="btn" style="width: 100%" onclick="checkAuthStatus()">
                                    üîç Verificar Estado de Autenticaci√≥n
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Patrones Implementados -->
                    <div style="margin-bottom: 30px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üõ°Ô∏è Patrones de Seguridad
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
                            <div
                                style="background: var(--gray-50); padding: 20px; border-left: 4px solid var(--primary)"
                            >
                                <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 1rem">
                                    Gatekeeper (API Gateway)
                                </h4>
                                <ul
                                    style="
                                        margin-left: 20px;
                                        line-height: 1.8;
                                        color: var(--gray-700);
                                        font-size: 0.9rem;
                                    "
                                >
                                    <li>Control de acceso centralizado</li>
                                    <li>Validaci√≥n de tokens JWT</li>
                                    <li>Rate Limiting (100 req/min)</li>
                                    <li>Protecci√≥n contra XSS, SQL Injection</li>
                                    <li>Headers de seguridad autom√°ticos</li>
                                    <li>Control de permisos por rol (RBAC)</li>
                                </ul>
                            </div>
                            <div
                                style="background: var(--gray-50); padding: 20px; border-left: 4px solid var(--success)"
                            >
                                <h4 style="color: var(--success); margin-bottom: 10px; font-size: 1rem">
                                    Federated Identity (LDAP)
                                </h4>
                                <ul
                                    style="
                                        margin-left: 20px;
                                        line-height: 1.8;
                                        color: var(--gray-700);
                                        font-size: 0.9rem;
                                    "
                                >
                                    <li>Autenticaci√≥n delegada a LDAP</li>
                                    <li>Single Sign-On (SSO)</li>
                                    <li>Sin gesti√≥n local de contrase√±as</li>
                                    <li>Mapeo autom√°tico de roles</li>
                                    <li>Tokens JWT internos (30 min)</li>
                                    <li>Integraci√≥n con Active Directory</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Pruebas de Seguridad -->
                    <div style="margin-bottom: 20px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üß™ Pruebas de Seguridad
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px">
                            <button class="btn" onclick="testProtectedEndpoint()">üîí Test Endpoint Protegido</button>
                            <button class="btn" onclick="testWithoutToken()">‚ùå Test Sin Token</button>
                            <button class="btn" onclick="testPermissions()">üîë Test Permisos por Rol</button>
                            <button class="btn" onclick="testRateLimit()">‚è±Ô∏è Test Rate Limiting</button>
                            <button class="btn" onclick="testMaliciousRequest()">üö® Test Ataque XSS</button>
                            <button class="btn" onclick="getUserPermissions()">üìú Ver Mis Permisos</button>
                            <button class="btn btn-success" onclick="runSecurityTestSuite()">
                                üéØ Suite Completa de Seguridad
                            </button>
                            <button class="btn" onclick="testInvalidToken()">üö´ Test Token Inv√°lido</button>
                            <button class="btn" onclick="testSQLInjection()">üíâ Test SQL Injection</button>
                        </div>
                    </div>

                    <!-- Resultados de Tests de Seguridad -->
                    <div
                        id="securityTestResults"
                        style="
                            display: none;
                            background: var(--gray-50);
                            padding: 20px;
                            border-left: 4px solid var(--primary);
                            margin-bottom: 20px;
                        "
                    >
                        <h4 style="margin-bottom: 15px; color: var(--gray-800)">üìä Resultados de Tests de Seguridad</h4>
                        <div id="securityResults"></div>
                    </div>

                    <!-- Permisos por Rol -->
                    <div>
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üé≠ Permisos por Rol
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px">
                            <div
                                style="
                                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                "
                            >
                                <h4 style="font-size: 1.1rem; margin-bottom: 10px">üëë Admin</h4>
                                <p style="font-size: 0.85rem; opacity: 0.9">Acceso total a todos los recursos</p>
                            </div>
                            <div
                                style="
                                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                "
                            >
                                <h4 style="font-size: 1.1rem; margin-bottom: 10px">‚≠ê Manager</h4>
                                <p style="font-size: 0.85rem; opacity: 0.9">Gesti√≥n completa de proyectos y tareas</p>
                            </div>
                            <div
                                style="
                                    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                "
                            >
                                <h4 style="font-size: 1.1rem; margin-bottom: 10px">üíª Developer</h4>
                                <p style="font-size: 0.85rem; opacity: 0.9">Lectura y actualizaci√≥n de tareas</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Demo Autom√°tica Tab -->
                <div id="demo" class="tab-content active">
                    <h2>üé¨ Demo Autom√°tica Completa</h2>
                    <p style="margin-bottom: 20px; color: var(--gray-600)">
                        Ejecuta una demostraci√≥n completa del sistema mostrando todas las funcionalidades.
                    </p>
                    <div class="demo-actions">
                        <button class="btn btn-success" onclick="runFullDemo()">Ejecutar Demo Completa</button>
                        <button class="btn" onclick="simulateRetry()">Simular Reintentos</button>
                        <button class="btn btn-danger" onclick="clearLogs()">Limpiar Logs</button>
                        <button class="btn" onclick="testPerformance()">Test Performance</button>
                    </div>
                </div>

                <!-- Proyectos Tab -->
                <div id="proyectos" class="tab-content">
                    <h2>üìã Gesti√≥n de Proyectos</h2>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px">
                        <div>
                            <h3 style="margin-bottom: 15px; font-size: 1rem; color: var(--gray-700)">Crear Proyecto</h3>
                            <div class="form-group">
                                <label>Nombre</label>
                                <input type="text" id="projectName" placeholder="Sistema de Facturaci√≥n" />
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n</label>
                                <textarea id="projectDesc" placeholder="Descripci√≥n del proyecto"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Estado</label>
                                <select id="projectStatus">
                                    <option value="activo">Activo</option>
                                    <option value="pausado">Pausado</option>
                                    <option value="completado">Completado</option>
                                </select>
                            </div>
                            <button class="btn btn-success" style="width: 100%" onclick="createProject()">
                                Crear Proyecto
                            </button>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 15px; font-size: 1rem; color: var(--gray-700)">
                                Lista de Proyectos
                            </h3>
                            <button class="btn btn-sm" onclick="loadProjects()" style="margin-bottom: 10px">
                                Actualizar Lista
                            </button>
                            <div id="projectsList"></div>
                        </div>
                    </div>
                </div>

                <!-- Tareas Tab -->
                <div id="tareas" class="tab-content">
                    <h2>‚úÖ Gesti√≥n de Tareas</h2>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px">
                        <div>
                            <h3 style="margin-bottom: 15px; font-size: 1rem; color: var(--gray-700)">Crear Tarea</h3>
                            <div class="form-group">
                                <label>T√≠tulo</label>
                                <input type="text" id="taskTitle" placeholder="Implementar API" />
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n</label>
                                <textarea id="taskDesc" placeholder="Descripci√≥n de la tarea"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Proyecto ID</label>
                                <input type="number" id="taskProject" placeholder="1" />
                            </div>
                            <div class="form-group">
                                <label>Estado</label>
                                <select id="taskStatus">
                                    <option value="pendiente">Pendiente</option>
                                    <option value="en_progreso">En Progreso</option>
                                    <option value="completada">Completada</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Prioridad</label>
                                <select id="taskPriority">
                                    <option value="alta">Alta</option>
                                    <option value="media">Media</option>
                                    <option value="baja">Baja</option>
                                </select>
                            </div>
                            <button class="btn btn-success" style="width: 100%" onclick="createTask()">
                                Crear Tarea
                            </button>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 15px; font-size: 1rem; color: var(--gray-700)">
                                Lista de Tareas
                            </h3>
                            <button class="btn btn-sm" onclick="loadTasks()" style="margin-bottom: 10px">
                                Actualizar Lista
                            </button>
                            <div id="tasksList"></div>
                        </div>
                    </div>
                </div>

                <!-- Queue-Based Load Leveling Tab -->
                <div id="queue" class="tab-content">
                    <h2>‚ö° Queue-Based Load Leveling</h2>
                    <p style="margin-bottom: 20px; color: var(--gray-600)">
                        Sistema de cola de mensajes para desacoplar la recepci√≥n de solicitudes de su procesamiento,
                        nivelando la carga y mejorando el rendimiento bajo alta demanda.
                    </p>

                    <!-- Estad√≠sticas de la Cola -->
                    <div
                        style="
                            background: var(--gray-50);
                            padding: 20px;
                            border-left: 4px solid var(--warning);
                            margin-bottom: 30px;
                        "
                    >
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üìä Estado de la Cola
                        </h3>
                        <div class="health-status">
                            <div class="health-item">
                                <label>Mensajes Pendientes</label>
                                <div class="value" id="queueSize">0</div>
                            </div>
                            <div class="health-item">
                                <label>Estado de Redis</label>
                                <div class="value" id="queueRedisStatus">üîÑ Verificando...</div>
                            </div>
                            <div class="health-item">
                                <label>Jobs Creados</label>
                                <div class="value" id="jobsCreated">0</div>
                            </div>
                            <div class="health-item">
                                <label>Tasa de Respuesta</label>
                                <div class="value" id="responseRate">0ms</div>
                            </div>
                        </div>
                        <button class="btn" onclick="updateQueueStats()" style="margin-top: 15px">
                            üîÑ Actualizar Estad√≠sticas
                        </button>
                    </div>

                    <!-- Patr√≥n Explicado -->
                    <div style="margin-bottom: 30px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">üìã C√≥mo Funciona</h3>
                        <div
                            style="
                                background: var(--gray-50);
                                padding: 20px;
                                border-left: 4px solid var(--primary);
                                margin-bottom: 20px;
                            "
                        >
                            <h4 style="margin-bottom: 10px; color: var(--primary)">
                                1. Cliente env√≠a solicitud (POST /tareas/):
                            </h4>
                            <ul style="margin-left: 20px; line-height: 1.8; color: var(--gray-700)">
                                <li>API pre-valida la solicitud (proyecto existe)</li>
                                <li>Encola mensaje en Redis con job_id √∫nico</li>
                                <li>
                                    Retorna
                                    <strong>inmediatamente</strong>
                                    HTTP 202 Accepted (< 50ms)
                                </li>
                            </ul>
                        </div>
                        <div
                            style="
                                background: var(--gray-50);
                                padding: 20px;
                                border-left: 4px solid var(--success);
                                margin-bottom: 20px;
                            "
                        >
                            <h4 style="margin-bottom: 10px; color: var(--success)">2. Worker procesa en background:</h4>
                            <ul style="margin-left: 20px; line-height: 1.8; color: var(--gray-700)">
                                <li>Worker extrae mensaje de la cola (BLPOP bloqueante)</li>
                                <li>Actualiza estado del job: pending ‚Üí processing</li>
                                <li>Procesa tarea (inserta en PostgreSQL)</li>
                                <li>Actualiza estado: processing ‚Üí completed/failed</li>
                                <li>Guarda resultado con TTL de 1 hora</li>
                            </ul>
                        </div>
                        <div style="background: var(--gray-50); padding: 20px; border-left: 4px solid var(--info)">
                            <h4 style="margin-bottom: 10px; color: var(--info)">3. Cliente consulta estado:</h4>
                            <ul style="margin-left: 20px; line-height: 1.8; color: var(--gray-700)">
                                <li>GET /tareas/jobs/{job_id} para ver estado actual</li>
                                <li>GET /tareas/jobs/{job_id}/result para obtener resultado</li>
                                <li>Estados: pending ‚Üí processing ‚Üí completed/failed</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Demo Interactiva -->
                    <div style="margin-bottom: 30px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üöÄ Prueba el Patr√≥n
                        </h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px">
                            <div>
                                <h4 style="margin-bottom: 10px; color: var(--gray-700)">Crear Tarea As√≠ncrona</h4>
                                <div class="form-group">
                                    <label>T√≠tulo de la Tarea</label>
                                    <input
                                        type="text"
                                        id="queueTaskTitle"
                                        placeholder="Tarea de prueba Load Leveling"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>Prioridad</label>
                                    <select id="queueTaskPriority">
                                        <option value="alta">Alta</option>
                                        <option value="media" selected>Media</option>
                                        <option value="baja">Baja</option>
                                    </select>
                                </div>
                                <button class="btn btn-success" onclick="createAsyncTask()">
                                    ‚ö° Crear Tarea As√≠ncrona
                                </button>
                            </div>

                            <div>
                                <h4 style="margin-bottom: 10px; color: var(--gray-700)">Consultar Job</h4>
                                <div class="form-group">
                                    <label>Job ID</label>
                                    <input type="text" id="jobIdInput" placeholder="abc-123-def-456" />
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap">
                                    <button class="btn" onclick="checkJobStatus()">üîç Ver Estado</button>
                                    <button class="btn btn-success" onclick="getJobResult()">
                                        üì• Obtener Resultado
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px">
                            <h4 style="margin-bottom: 10px; color: var(--gray-700)">‚ö° Prueba de Carga Concurrente</h4>
                            <p style="color: var(--gray-600); margin-bottom: 10px; font-size: 0.9rem">
                                Crea m√∫ltiples tareas simult√°neamente para demostrar la nivelaci√≥n de carga
                            </p>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap">
                                <label style="color: var(--gray-700)">Cantidad:</label>
                                <input
                                    type="number"
                                    id="concurrentTasks"
                                    value="10"
                                    min="1"
                                    max="100"
                                    style="
                                        width: 80px;
                                        padding: 8px;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 4px;
                                    "
                                />
                                <button class="btn btn-success" onclick="createConcurrentTasks()">
                                    üî• Crear Tareas Concurrentes
                                </button>
                                <button class="btn" onclick="monitorActiveJobs()">üìä Monitorear Jobs Activos</button>
                            </div>
                        </div>
                    </div>

                    <!-- Jobs Activos -->
                    <div style="margin-bottom: 30px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üìã Jobs Recientes
                        </h3>
                        <div
                            id="activeJobsList"
                            style="
                                background: white;
                                border: 1px solid var(--gray-200);
                                padding: 15px;
                                max-height: 300px;
                                overflow-y: auto;
                            "
                        >
                            <p style="color: var(--gray-500); text-align: center">No hay jobs recientes</p>
                        </div>
                    </div>

                    <!-- Beneficios -->
                    <div style="margin-bottom: 20px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üìà Beneficios del Patr√≥n
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px">
                            <div
                                style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                    text-align: center;
                                "
                            >
                                <h4 style="font-size: 2rem; margin-bottom: 5px">85-90%</h4>
                                <p style="font-size: 0.9rem">M√°s r√°pido (< 50ms)</p>
                            </div>
                            <div
                                style="
                                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                    text-align: center;
                                "
                            >
                                <h4 style="font-size: 2rem; margin-bottom: 5px">10x</h4>
                                <p style="font-size: 0.9rem">Mayor throughput</p>
                            </div>
                            <div
                                style="
                                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                    text-align: center;
                                "
                            >
                                <h4 style="font-size: 2rem; margin-bottom: 5px">100%</h4>
                                <p style="font-size: 0.9rem">Absorci√≥n de picos</p>
                            </div>
                        </div>
                    </div>

                    <!-- Nota sobre Worker -->
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 15px; border-radius: 6px">
                        <h4 style="color: #92400e; margin-bottom: 8px; display: flex; align-items: center; gap: 8px">
                            <span style="font-size: 1.2rem">‚ö†Ô∏è</span>
                            Importante: Worker Requerido
                        </h4>
                        <p style="color: #78350f; margin-bottom: 8px">
                            Para que las tareas se procesen, debes tener el worker ejecut√°ndose:
                        </p>
                        <div
                            style="
                                background: white;
                                padding: 10px;
                                border-radius: 4px;
                                font-family: monospace;
                                color: var(--gray-700);
                                margin-bottom: 8px;
                            "
                        >
                            ./scripts/start_worker.sh # Linux/Mac
                            <br />
                            scripts\start_worker.bat # Windows
                        </div>
                        <p style="color: var(--gray-600); font-size: 0.9rem">
                            Sin el worker, las tareas quedar√°n en estado "pending" indefinidamente.
                        </p>
                    </div>
                </div>

                <!-- Cache-Aside Tab -->
                <div id="cache" class="tab-content">
                    <h2>üíæ Sistema de Cach√© Cache-Aside con Redis</h2>
                    <p style="margin-bottom: 20px; color: var(--gray-600)">
                        Sistema de cach√© distribuido que reduce la latencia en las consultas m√°s frecuentes
                    </p>

                    <div style="margin-bottom: 30px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üìä Estad√≠sticas Detalladas
                        </h3>
                        <div class="health-status">
                            <div class="health-item">
                                <label>Estado de Redis</label>
                                <div class="value" id="cacheStatusDetail">-</div>
                            </div>
                            <div class="health-item">
                                <label>Claves en Cach√©</label>
                                <div class="value" id="cacheKeysDetail">-</div>
                            </div>
                            <div class="health-item">
                                <label>Cache Hits</label>
                                <div class="value" id="cacheHitsDetail">-</div>
                            </div>
                            <div class="health-item">
                                <label>Cache Misses</label>
                                <div class="value" id="cacheMissesDetail">-</div>
                            </div>
                            <div class="health-item">
                                <label>Hit Rate %</label>
                                <div class="value" id="cacheHitRateDetail">-</div>
                            </div>
                            <div class="health-item">
                                <label>Memoria Redis</label>
                                <div class="value" id="cacheMemoryDetail">-</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            üîÑ Patr√≥n Cache-Aside
                        </h3>
                        <div
                            style="
                                background: var(--gray-50);
                                padding: 20px;
                                border-left: 4px solid var(--primary);
                                margin-bottom: 20px;
                            "
                        >
                            <h4 style="margin-bottom: 10px; color: var(--primary)">Lectura (GET):</h4>
                            <ol style="margin-left: 20px; line-height: 1.8">
                                <li>Cliente solicita datos a la API</li>
                                <li>API busca en Redis (cach√©)</li>
                                <li>
                                    <strong>Cache HIT</strong>
                                    ‚Üí Devuelve desde Redis (‚ö° 1-5ms)
                                </li>
                                <li>
                                    <strong>Cache MISS</strong>
                                    ‚Üí Consulta PostgreSQL (50-100ms)
                                </li>
                                <li>Guarda resultado en Redis para futuras consultas</li>
                                <li>Devuelve datos al cliente</li>
                            </ol>
                        </div>
                        <div
                            style="
                                background: var(--gray-50);
                                padding: 20px;
                                border-left: 4px solid var(--success);
                                margin-bottom: 20px;
                            "
                        >
                            <h4 style="margin-bottom: 10px; color: var(--success)">Escritura (POST/PUT/DELETE):</h4>
                            <ol style="margin-left: 20px; line-height: 1.8">
                                <li>Cliente env√≠a modificaci√≥n</li>
                                <li>API actualiza PostgreSQL</li>
                                <li>API invalida cach√© relacionada en Redis</li>
                                <li>Pr√≥xima lectura regenerar√° cach√© con datos actualizados</li>
                            </ol>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">
                            ‚úÖ Endpoints Optimizados
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px">
                            <div style="background: white; border: 1px solid var(--gray-200); padding: 15px">
                                <h4 style="color: var(--primary); margin-bottom: 5px">GET /api/v1/proyectos</h4>
                                <p style="color: var(--gray-600); font-size: 0.9rem">Lista de proyectos con filtros</p>
                                <span
                                    style="
                                        background: var(--success);
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 3px;
                                        font-size: 0.8rem;
                                    "
                                >
                                    Cache-Aside ‚úì
                                </span>
                            </div>
                            <div style="background: white; border: 1px solid var(--gray-200); padding: 15px">
                                <h4 style="color: var(--primary); margin-bottom: 5px">GET /api/v1/proyectos/{id}</h4>
                                <p style="color: var(--gray-600); font-size: 0.9rem">Proyecto individual</p>
                                <span
                                    style="
                                        background: var(--success);
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 3px;
                                        font-size: 0.8rem;
                                    "
                                >
                                    Cache-Aside ‚úì
                                </span>
                            </div>
                            <div style="background: white; border: 1px solid var(--gray-200); padding: 15px">
                                <h4 style="color: var(--primary); margin-bottom: 5px">GET /api/v1/tareas</h4>
                                <p style="color: var(--gray-600); font-size: 0.9rem">
                                    Lista de tareas con m√∫ltiples filtros
                                </p>
                                <span
                                    style="
                                        background: var(--success);
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 3px;
                                        font-size: 0.8rem;
                                    "
                                >
                                    Cache-Aside ‚úì
                                </span>
                            </div>
                            <div style="background: white; border: 1px solid var(--gray-200); padding: 15px">
                                <h4 style="color: var(--primary); margin-bottom: 5px">GET /api/v1/tareas/{id}</h4>
                                <p style="color: var(--gray-600); font-size: 0.9rem">Tarea individual</p>
                                <span
                                    style="
                                        background: var(--success);
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 3px;
                                        font-size: 0.8rem;
                                    "
                                >
                                    Cache-Aside ‚úì
                                </span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">üß™ Probar Cach√©</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap">
                            <button class="btn btn-success" onclick="testCachePerformance()">
                                Test de Rendimiento
                            </button>
                            <button class="btn" onclick="checkCacheStats()">Actualizar Estad√≠sticas</button>
                            <button class="btn" onclick="demonstrateCache()">Demostraci√≥n Cache HIT/MISS</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--gray-700)">üìà Beneficios</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px">
                            <div
                                style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                    text-align: center;
                                "
                            >
                                <h4 style="font-size: 2rem; margin-bottom: 5px">10-100x</h4>
                                <p style="font-size: 0.9rem">M√°s r√°pido en cache hits</p>
                            </div>
                            <div
                                style="
                                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                    text-align: center;
                                "
                            >
                                <h4 style="font-size: 2rem; margin-bottom: 5px">70-80%</h4>
                                <p style="font-size: 0.9rem">Reducci√≥n carga en DB</p>
                            </div>
                            <div
                                style="
                                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                    text-align: center;
                                "
                            >
                                <h4 style="font-size: 2rem; margin-bottom: 5px">5-10x</h4>
                                <p style="font-size: 0.9rem">M√°s requests/segundo</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sistema Retry Tab -->
                <div id="retry" class="tab-content">
                    <h2>üîÑ Sistema de Reintentos</h2>
                    <p style="margin-bottom: 20px; color: var(--gray-600)">
                        El sistema implementa reintentos autom√°ticos con backoff exponencial
                    </p>
                    <div class="health-status" style="margin-bottom: 20px">
                        <div class="health-item">
                            <label>Intentos M√°ximos</label>
                            <div class="value">5</div>
                        </div>
                        <div class="health-item">
                            <label>Espera M√≠nima</label>
                            <div class="value">1s</div>
                        </div>
                        <div class="health-item">
                            <label>Espera M√°xima</label>
                            <div class="value">10s</div>
                        </div>
                        <div class="health-item">
                            <label>Patr√≥n</label>
                            <div class="value">Exponencial</div>
                        </div>
                    </div>
                    <div class="demo-actions">
                        <button class="btn" onclick="simulateRetry()">Simular Reintentos</button>
                        <button class="btn" onclick="testConnectionPool()">Test Pool Conexiones</button>
                        <button class="btn" onclick="checkHealth()">Verificar Estado</button>
                    </div>
                    <div
                        style="
                            margin-top: 20px;
                            padding: 16px;
                            background: var(--gray-50);
                            border-left: 4px solid var(--primary);
                        "
                    >
                        <h4 style="margin-bottom: 12px; color: var(--gray-900); font-size: 1rem">
                            Configuraci√≥n del Pool
                        </h4>
                        <div style="color: var(--gray-700); font-size: 0.9375rem; line-height: 1.8">
                            <div style="padding: 6px 0; border-bottom: 1px solid var(--gray-200)">
                                <strong>Pool Size:</strong>
                                10 conexiones base
                            </div>
                            <div style="padding: 6px 0; border-bottom: 1px solid var(--gray-200)">
                                <strong>Max Overflow:</strong>
                                20 conexiones adicionales
                            </div>
                            <div style="padding: 6px 0; border-bottom: 1px solid var(--gray-200)">
                                <strong>Pool Timeout:</strong>
                                30 segundos
                            </div>
                            <div style="padding: 6px 0">
                                <strong>Pool Recycle:</strong>
                                5 minutos
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Card -->
            <div class="card" style="margin-top: 24px">
                <h2>üìù Logs del Sistema</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info">
                        <span class="log-timestamp">[Inicio]</span>
                        Sistema iniciado. Esperando operaciones...
                    </div>
                </div>
            </div>
        </div>

        <script>
            const API_URL = window.location.origin;
            let demoRunning = false;
            let authToken = localStorage.getItem("authToken") || null;
            let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");

            function switchTab(tabName) {
                document.querySelectorAll(".tab").forEach((tab) => tab.classList.remove("active"));
                document.querySelectorAll(".tab-content").forEach((content) => content.classList.remove("active"));

                event.target.classList.add("active");
                document.getElementById(tabName).classList.add("active");

                if (tabName === "proyectos") loadProjects();
                if (tabName === "tareas") loadTasks();
            }

            function addLog(message, type = "info") {
                const logContainer = document.getElementById("logContainer");
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement("div");
                logEntry.className = `log-entry ${type}`;
                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            function clearLogs() {
                document.getElementById("logContainer").innerHTML = `
                <div class="log-entry info">
                    <span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    Logs limpiados
                </div>
            `;
            }

            async function checkHealth() {
                addLog("Verificando estado del sistema...", "info");
                try {
                    const response = await fetch(`${API_URL}/health`);
                    const data = await response.json();

                    document.getElementById("systemStatus").textContent =
                        data.status === "healthy" ? "‚úì Healthy" : "‚úó Unhealthy";
                    document.getElementById("dbStatus").textContent =
                        data.database?.database === "connected" ? "‚úì Conectada" : "‚úó Desconectada";
                    document.getElementById("responseTime").textContent = `${data.database?.response_time_ms || 0}ms`;
                    document.getElementById("poolInfo").textContent =
                        `${data.database?.pool_checked_out || 0}/${data.database?.pool_size || 0}`;

                    document.querySelectorAll(".health-item").forEach((item) => {
                        item.classList.remove("success", "warning");
                        item.classList.add("success");
                    });

                    addLog(`Sistema healthy - BD respondiendo en ${data.database?.response_time_ms}ms`, "success");
                    addLog(
                        `Pool: ${data.database?.pool_checked_out} en uso, ${data.database?.pool_checked_in} disponibles`,
                        "info",
                    );
                } catch (error) {
                    addLog(`Error al verificar estado: ${error.message}`, "error");
                    document.getElementById("systemStatus").textContent = "‚úó Error";
                }
            }

            async function updateStats() {
                try {
                    const response = await fetch(`${API_URL}/stats`);
                    const stats = await response.json();

                    document.getElementById("userCount").textContent = stats.usuarios;
                    document.getElementById("projectCount").textContent = stats.proyectos;
                    document.getElementById("taskCount").textContent = stats.tareas;

                    addLog(
                        `Estad√≠sticas: ${stats.usuarios} usuarios, ${stats.proyectos} proyectos, ${stats.tareas} tareas`,
                        "success",
                    );
                } catch (error) {
                    addLog(`Error al actualizar estad√≠sticas: ${error.message}`, "error");
                }
            }

            async function createProject() {
                const projectData = {
                    nombre: document.getElementById("projectName").value,
                    descripcion: document.getElementById("projectDesc").value,
                    estado: document.getElementById("projectStatus").value,
                };

                if (!projectData.nombre) {
                    addLog("Por favor completa el nombre del proyecto", "warning");
                    return;
                }

                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                addLog(`POST /api/v1/proyectos - Creando: ${projectData.nombre}`, "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/proyectos`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${authToken}`
                        },
                        body: JSON.stringify(projectData),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        addLog(`Proyecto creado: ${data.nombre} (ID: ${data.id})`, "success");
                        document.getElementById("projectName").value = "";
                        document.getElementById("projectDesc").value = "";
                        loadProjects();
                        updateStats();
                    } else {
                        addLog(`Error: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function loadProjects() {
                try {
                    if (!authToken) {
                        addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                        return;
                    }

                    addLog("Cargando proyectos...", "info");
                    const response = await fetch(`${API_URL}/api/v1/proyectos`, {
                        headers: { Authorization: `Bearer ${authToken}` },
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        addLog(`Error: ${error.detail || 'Error al cargar proyectos'}`, "error");
                        return;
                    }

                    const projects = await response.json();

                    const projectsList = document.getElementById("projectsList");
                    if (!Array.isArray(projects) || projects.length === 0) {
                        projectsList.innerHTML =
                            '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No hay proyectos</p>';
                        return;
                    }

                    projectsList.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th>Usuarios</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${projects
                                .map(
                                    (project) => `
                                <tr>
                                    <td>${project.id}</td>
                                    <td>${project.nombre}</td>
                                    <td><span class="badge badge-${project.estado === "activo" ? "success" : "warning"}">${project.estado}</span></td>
                                    <td>${project.usuarios?.length || 0}</td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;
                    addLog(`${projects.length} proyectos cargados`, "success");
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function createTask() {
                const taskData = {
                    titulo: document.getElementById("taskTitle").value,
                    descripcion: document.getElementById("taskDesc").value,
                    proyecto_id: parseInt(document.getElementById("taskProject").value),
                    estado: document.getElementById("taskStatus").value,
                    prioridad: document.getElementById("taskPriority").value,
                };

                if (!taskData.titulo || !taskData.proyecto_id) {
                    addLog("Completa t√≠tulo y proyecto ID", "warning");
                    return;
                }

                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                addLog(`POST /api/v1/tareas - Creando: ${taskData.titulo}`, "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/tareas`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${authToken}`
                        },
                        body: JSON.stringify(taskData),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        addLog(`Tarea creada: ${data.titulo} (ID: ${data.id})`, "success");
                        document.getElementById("taskTitle").value = "";
                        document.getElementById("taskDesc").value = "";
                        loadTasks();
                        updateStats();
                    } else {
                        addLog(`Error: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function loadTasks() {
                try {
                    if (!authToken) {
                        addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                        return;
                    }

                    addLog("Cargando tareas...", "info");
                    const response = await fetch(`${API_URL}/api/v1/tareas`, {
                        headers: { Authorization: `Bearer ${authToken}` },
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        addLog(`Error: ${error.detail || 'Error al cargar tareas'}`, "error");
                        return;
                    }

                    const tasks = await response.json();

                    const tasksList = document.getElementById("tasksList");
                    if (!Array.isArray(tasks) || tasks.length === 0) {
                        tasksList.innerHTML =
                            '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No hay tareas</p>';
                        return;
                    }

                    tasksList.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√≠tulo</th>
                                <th>Estado</th>
                                <th>Prioridad</th>
                                <th>Proyecto</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tasks
                                .map(
                                    (task) => `
                                <tr>
                                    <td>${task.id}</td>
                                    <td>${task.titulo}</td>
                                    <td><span class="badge badge-${task.estado === "completada" ? "success" : task.estado === "en_progreso" ? "warning" : "info"}">${task.estado}</span></td>
                                    <td><span class="badge badge-${task.prioridad === "alta" ? "danger" : task.prioridad === "media" ? "warning" : "info"}">${task.prioridad}</span></td>
                                    <td>${task.proyecto_id}</td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;
                    addLog(`${tasks.length} tareas cargadas`, "success");
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function simulateRetry() {
                addLog("Simulando reintentos con backoff exponencial...", "info");
                const attempts = [0, 1000, 2000, 4000, 8000];

                for (let i = 0; i < 5; i++) {
                    await new Promise((resolve) => setTimeout(resolve, attempts[i]));

                    if (i < 4) {
                        addLog(`Intento ${i + 1}/5 - Esperando ${attempts[i + 1] / 1000}s`, "warning");
                    } else {
                        addLog(`Intento ${i + 1}/5 - Conexi√≥n exitosa`, "success");
                    }
                }
            }

            async function testPerformance() {
                addLog("Test de performance (10 requests)...", "info");
                const startTime = Date.now();

                try {
                    const promises = [];
                    for (let i = 0; i < 10; i++) {
                        promises.push(fetch(`${API_URL}/health`));
                    }

                    await Promise.all(promises);
                    const elapsed = (Date.now() - startTime) / 1000;
                    const rps = (10 / elapsed).toFixed(2);

                    addLog(`Test completado: 10 requests en ${elapsed.toFixed(2)}s (${rps} req/s)`, "success");
                    addLog(
                        'üí° Usa "Test de Rendimiento" en la pesta√±a Cache-Aside para ver el impacto del cach√©',
                        "info",
                    );
                } catch (error) {
                    addLog(`Error en test: ${error.message}`, "error");
                }
            }

            async function testConnectionPool() {
                addLog("Probando pool de conexiones...", "info");
                await checkHealth();
                addLog("Health check muestra estado del pool", "info");
            }

            async function runFullDemo() {
                if (demoRunning) {
                    addLog("Demo ya en ejecuci√≥n", "warning");
                    return;
                }

                demoRunning = true;
                addLog("Iniciando demo completa...", "info");

                try {
                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASO 1: HEALTH CHECK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    await checkHealth();
                    await sleep(2000);

                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASO 2: CREAR PROYECTOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    const projects = [
                        { nombre: "Sistema de Facturaci√≥n", descripcion: "Sistema web", estado: "activo" },
                        { nombre: "App M√≥vil", descripcion: "App para vendedores", estado: "activo" },
                    ];

                    for (const project of projects) {
                        await createProjectAPI(project);
                        await sleep(1000);
                    }

                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASO 3: CREAR TAREAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    const tasks = [
                        {
                            titulo: "Dise√±ar BD",
                            descripcion: "Diagrama ER",
                            proyecto_id: 1,
                            estado: "pendiente",
                            prioridad: "alta",
                        },
                        {
                            titulo: "Implementar API",
                            descripcion: "Endpoints REST",
                            proyecto_id: 1,
                            estado: "en_progreso",
                            prioridad: "alta",
                        },
                        {
                            titulo: "Tests unitarios",
                            descripcion: "Pruebas",
                            proyecto_id: 1,
                            estado: "pendiente",
                            prioridad: "media",
                        },
                    ];

                    for (const task of tasks) {
                        await createTaskAPI(task);
                        await sleep(1000);
                    }

                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASO 4: SISTEMA DE RETRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    await simulateRetry();
                    await sleep(1000);

                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASO 5: TEST PERFORMANCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    await testPerformance();

                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASO 6: ESTAD√çSTICAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    await updateStats();

                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASO 7: ESTAD√çSTICAS DE CACH√â ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    await checkCacheStats();

                    addLog("‚úÖ Demo completada exitosamente", "success");
                    addLog('üí° Visita la pesta√±a "Cache-Aside" para m√°s pruebas de rendimiento', "info");
                } catch (error) {
                    addLog(`Error en demo: ${error.message}`, "error");
                } finally {
                    demoRunning = false;
                }
            }

            async function createProjectAPI(projectData) {
                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero para crear proyectos", "warning");
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/api/v1/proyectos`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${authToken}`
                        },
                        body: JSON.stringify(projectData),
                    });
                    const data = await response.json();

                    if (response.ok) {
                        addLog(`Proyecto creado: ${data.nombre} (ID: ${data.id})`, "success");
                    } else {
                        addLog(`Error: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function createTaskAPI(taskData) {
                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero para crear tareas", "warning");
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/api/v1/tareas`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${authToken}`
                        },
                        body: JSON.stringify(taskData),
                    });
                    const data = await response.json();

                    if (response.ok) {
                        addLog(`Tarea creada: ${data.titulo} (ID: ${data.id})`, "success");
                    } else {
                        addLog(`Error: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            function sleep(ms) {
                return new Promise((resolve) => setTimeout(resolve, ms));
            }

            // ========== FUNCIONES DE AUTENTICACI√ìN Y SEGURIDAD ==========

            async function loginLDAP() {
                const username = document.getElementById("ldapUsername").value;
                const password = document.getElementById("ldapPassword").value;

                if (!username || !password) {
                    addLog("Por favor ingresa usuario y contrase√±a", "warning");
                    return;
                }

                addLog(`Autenticando usuario: ${username} contra LDAP...`, "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/auth/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username, password }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        authToken = data.access_token;
                        currentUser = data.user;

                        localStorage.setItem("authToken", authToken);
                        localStorage.setItem("currentUser", JSON.stringify(currentUser));

                        addLog(`‚úÖ Autenticaci√≥n exitosa! Bienvenido ${currentUser.nombre}`, "success");
                        addLog(`Rol asignado: ${currentUser.rol}`, "info");
                        addLog(`Token v√°lido por ${data.expires_in / 60} minutos`, "info");

                        updateAuthState();
                        document.getElementById("ldapPassword").value = "";
                    } else {
                        addLog(`‚ùå Error de autenticaci√≥n: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error de conexi√≥n: ${error.message}`, "error");
                }
            }

            function logout() {
                if (!authToken) {
                    addLog("No hay sesi√≥n activa", "warning");
                    return;
                }

                authToken = null;
                currentUser = null;

                localStorage.removeItem("authToken");
                localStorage.removeItem("currentUser");

                addLog("‚úÖ Sesi√≥n cerrada exitosamente", "success");
                updateAuthState();
            }

            function updateAuthState() {
                const authStateDiv = document.getElementById("authState");
                const userInfoDiv = document.getElementById("userInfo");

                if (currentUser && authToken) {
                    authStateDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">
                            ${currentUser.nombre.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">
                                ${currentUser.nombre}
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray-600);">
                                ${currentUser.email}
                            </div>
                        </div>
                        <div>
                            <span style="background: var(--success); color: white; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                ‚úì Autenticado
                            </span>
                        </div>
                    </div>
                `;

                    userInfoDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.8rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em;">Usuario LDAP</label>
                        <div style="font-size: 1rem; color: var(--gray-900); font-weight: 500;">${currentUser.username}</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.8rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em;">Email</label>
                        <div style="font-size: 1rem; color: var(--gray-900);">${currentUser.email}</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.8rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em;">Rol</label>
                        <div>
                            <span class="badge ${currentUser.rol === "admin" ? "badge-success" : currentUser.rol === "manager" ? "badge-warning" : "badge-info"}">
                                ${currentUser.rol.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    ${
                        currentUser.ldap_dn
                            ? `
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.8rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em;">LDAP DN</label>
                        <div style="font-size: 0.85rem; color: var(--gray-700); font-family: monospace; word-break: break-all;">${currentUser.ldap_dn}</div>
                    </div>
                    `
                            : ""
                    }
                    <div style="background: var(--gray-50); padding: 10px; border-radius: 4px; margin-top: 15px;">
                        <div style="font-size: 0.8rem; color: var(--gray-600); margin-bottom: 4px;">Token JWT (truncado)</div>
                        <div style="font-size: 0.75rem; color: var(--gray-700); font-family: monospace; word-break: break-all;">${authToken.substring(0, 50)}...</div>
                    </div>
                `;
                } else {
                    authStateDiv.innerHTML =
                        '<div style="color: var(--gray-600);">‚ùå No autenticado. Por favor inicia sesi√≥n.</div>';
                    userInfoDiv.innerHTML =
                        '<p style="color: var(--gray-500); text-align: center; padding: 40px 0;">No hay sesi√≥n activa</p>';
                }
            }

            async function checkAuthStatus() {
                addLog("Verificando estado de autenticaci√≥n...", "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/auth/status`);
                    const data = await response.json();

                    addLog(`Estado: ${data.status}`, "info");
                    addLog(`M√©todo de autenticaci√≥n: ${data.authentication_method}`, "info");
                    addLog(
                        `LDAP: ${data.ldap_connection}`,
                        data.ldap_connection === "connected" ? "success" : "warning",
                    );

                    if (authToken) {
                        const meResponse = await fetch(`${API_URL}/api/v1/auth/me`, {
                            headers: { Authorization: `Bearer ${authToken}` },
                        });

                        if (meResponse.ok) {
                            const userData = await meResponse.json();
                            addLog(`‚úÖ Token v√°lido - Usuario: ${userData.nombre}`, "success");
                        } else {
                            addLog("‚ö†Ô∏è Token inv√°lido o expirado", "warning");
                            logout();
                        }
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function testProtectedEndpoint() {
                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                addLog("Probando acceso a endpoint protegido...", "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/proyectos`, {
                        headers: { Authorization: `Bearer ${authToken}` },
                    });

                    if (response.ok) {
                        const data = await response.json();
                        addLog(`‚úÖ Acceso autorizado - ${data.length} proyectos encontrados`, "success");
                    } else {
                        addLog(`‚ùå Acceso denegado: ${response.status}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function testWithoutToken() {
                addLog("Probando acceso sin token (deber√≠a fallar con 401)...", "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/proyectos/`);
                    const data = await response.json();

                    if (response.status === 401) {
                        addLog(`‚úÖ Gatekeeper funcionando correctamente`, "success");
                        addLog(`   HTTP ${response.status}: ${data.detail}`, "info");
                    } else if (response.ok) {
                        addLog("‚ùå ERROR: Endpoint accesible sin token!", "error");
                    } else {
                        addLog(`‚ö†Ô∏è Respuesta inesperada: HTTP ${response.status}`, "warning");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function testPermissions() {
                if (!authToken || !currentUser) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                addLog(`Probando permisos para rol: ${currentUser.rol}...`, "info");

                // Test 1: Crear proyecto (requiere admin o manager)
                try {
                    const response = await fetch(`${API_URL}/api/v1/proyectos`, {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${authToken}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            nombre: "Test Permisos",
                            descripcion: `Proyecto de prueba ${Date.now()}`,
                            estado: "activo",
                        }),
                    });

                    if (response.ok) {
                        addLog(`‚úÖ Permiso CREAR PROYECTO: Autorizado`, "success");
                    } else {
                        addLog(`‚ùå Permiso CREAR PROYECTO: Denegado (${response.status})`, "warning");
                    }
                } catch (error) {
                    addLog(`Error en test de permisos: ${error.message}`, "error");
                }
            }

            async function testRateLimit() {
                addLog("üî• Probando Rate Limiting (100 requests)...", "info");
                addLog("Esto puede tomar unos segundos...", "info");

                let successCount = 0;
                let blockedCount = 0;

                for (let i = 0; i < 105; i++) {
                    try {
                        const response = await fetch(`${API_URL}/api/v1/auth/status`);
                        if (response.status === 429) {
                            blockedCount++;
                            if (blockedCount === 1) {
                                addLog(`üö® Rate limit alcanzado en request ${i + 1}`, "warning");
                            }
                        } else {
                            successCount++;
                        }
                    } catch (error) {
                        // Ignorar errores
                    }
                }

                addLog(`‚úÖ Exitosos: ${successCount}`, "success");
                addLog(`üö´ Bloqueados: ${blockedCount}`, blockedCount > 0 ? "warning" : "info");
                addLog("üí° Rate Limiting funcionando correctamente", "success");
            }

            async function testMaliciousRequest() {
                addLog("üö® Probando protecci√≥n contra XSS...", "info");

                const xssPayload = '<script>alert("xss")<\/script>';

                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/proyectos/?search=${encodeURIComponent(xssPayload)}`,
                    );
                    const data = await response.json();

                    if (response.status === 400) {
                        addLog(`‚úÖ Gatekeeper bloque√≥ el ataque XSS`, "success");
                        addLog(`   HTTP ${response.status}: ${data.detail}`, "info");
                    } else if (response.status === 401) {
                        addLog("‚ö†Ô∏è Bloqueado por falta de token (antes de llegar al filtro XSS)", "warning");
                    } else {
                        addLog("‚ùå ERROR: Solicitud maliciosa no bloqueada", "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function testInvalidToken() {
                addLog("üö´ Probando token inv√°lido...", "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/proyectos/`, {
                        headers: { Authorization: "Bearer token_invalido_xyz123" },
                    });
                    const data = await response.json();

                    if (response.status === 401) {
                        addLog(`‚úÖ Token inv√°lido rechazado correctamente`, "success");
                        addLog(`   HTTP ${response.status}: ${data.detail}`, "info");
                    } else {
                        addLog(`‚ùå ERROR: Token inv√°lido aceptado!`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function testSQLInjection() {
                addLog("üíâ Probando protecci√≥n contra SQL Injection...", "info");

                const sqlPayload = "' OR '1'='1";

                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/proyectos/?nombre=${encodeURIComponent(sqlPayload)}`,
                    );
                    const data = await response.json();

                    if (response.status === 400) {
                        addLog(`‚úÖ Gatekeeper bloque√≥ SQL Injection`, "success");
                        addLog(`   HTTP ${response.status}: ${data.detail}`, "info");
                    } else if (response.status === 401) {
                        addLog("‚ö†Ô∏è Bloqueado por falta de token (antes de llegar al filtro SQL)", "warning");
                    } else {
                        addLog(
                            "‚ö†Ô∏è Nota: SQL Injection pas√≥ el filtro (puede ser seguro si usa queries parametrizadas)",
                            "warning",
                        );
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function runSecurityTestSuite() {
                addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                addLog("üéØ INICIANDO SUITE COMPLETA DE SEGURIDAD", "info");
                addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");

                const results = {
                    passed: 0,
                    failed: 0,
                    total: 0,
                };

                // Test 1: Endpoint p√∫blico
                addLog("Test 1/6: Endpoint p√∫blico accesible", "info");
                try {
                    const r1 = await fetch(`${API_URL}/health`);
                    if (r1.ok) {
                        addLog("‚úÖ Test 1 PASADO", "success");
                        results.passed++;
                    } else {
                        addLog("‚ùå Test 1 FALLIDO", "error");
                        results.failed++;
                    }
                    results.total++;
                } catch (e) {
                    addLog("‚ùå Test 1 ERROR", "error");
                    results.failed++;
                    results.total++;
                }
                await sleep(500);

                // Test 2: Endpoint protegido sin token
                addLog("Test 2/6: Endpoint protegido sin token debe fallar", "info");
                try {
                    const r2 = await fetch(`${API_URL}/api/v1/proyectos/`);
                    if (r2.status === 401) {
                        addLog("‚úÖ Test 2 PASADO (HTTP 401)", "success");
                        results.passed++;
                    } else {
                        addLog(`‚ùå Test 2 FALLIDO (HTTP ${r2.status})`, "error");
                        results.failed++;
                    }
                    results.total++;
                } catch (e) {
                    addLog("‚ùå Test 2 ERROR", "error");
                    results.failed++;
                    results.total++;
                }
                await sleep(500);

                // Test 3: Login y obtener token
                addLog("Test 3/6: Login LDAP exitoso", "info");
                try {
                    const r3 = await fetch(`${API_URL}/api/v1/auth/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username: "admin", password: "admin_password" }),
                    });
                    const d3 = await r3.json();
                    if (r3.ok && d3.access_token) {
                        authToken = d3.access_token;
                        currentUser = d3.user;
                        localStorage.setItem("authToken", authToken);
                        localStorage.setItem("currentUser", JSON.stringify(currentUser));
                        updateAuthState();
                        addLog("‚úÖ Test 3 PASADO (Token obtenido)", "success");
                        results.passed++;
                    } else {
                        addLog("‚ùå Test 3 FALLIDO", "error");
                        results.failed++;
                    }
                    results.total++;
                } catch (e) {
                    addLog("‚ùå Test 3 ERROR", "error");
                    results.failed++;
                    results.total++;
                }
                await sleep(500);

                // Test 4: Endpoint protegido con token v√°lido
                addLog("Test 4/6: Endpoint protegido con token v√°lido", "info");
                try {
                    const r4 = await fetch(`${API_URL}/api/v1/proyectos/`, {
                        headers: { Authorization: `Bearer ${authToken}` },
                    });
                    if (r4.ok) {
                        addLog("‚úÖ Test 4 PASADO (HTTP 200)", "success");
                        results.passed++;
                    } else {
                        addLog(`‚ùå Test 4 FALLIDO (HTTP ${r4.status})`, "error");
                        results.failed++;
                    }
                    results.total++;
                } catch (e) {
                    addLog("‚ùå Test 4 ERROR", "error");
                    results.failed++;
                    results.total++;
                }
                await sleep(500);

                // Test 5: Token inv√°lido
                addLog("Test 5/6: Token inv√°lido debe ser rechazado", "info");
                try {
                    const r5 = await fetch(`${API_URL}/api/v1/proyectos/`, {
                        headers: { Authorization: "Bearer token_invalido" },
                    });
                    if (r5.status === 401) {
                        addLog("‚úÖ Test 5 PASADO (HTTP 401)", "success");
                        results.passed++;
                    } else {
                        addLog(`‚ùå Test 5 FALLIDO (HTTP ${r5.status})`, "error");
                        results.failed++;
                    }
                    results.total++;
                } catch (e) {
                    addLog("‚ùå Test 5 ERROR", "error");
                    results.failed++;
                    results.total++;
                }
                await sleep(500);

                // Test 6: Protecci√≥n XSS
                addLog("Test 6/6: Protecci√≥n contra XSS", "info");
                try {
                    const r6 = await fetch(`${API_URL}/api/v1/proyectos/?search=%3Cscript%3Ealert('xss')%3C/script%3E`);
                    if (r6.status === 400 || r6.status === 401) {
                        addLog(`‚úÖ Test 6 PASADO (HTTP ${r6.status})`, "success");
                        results.passed++;
                    } else {
                        addLog(`‚ùå Test 6 FALLIDO (HTTP ${r6.status})`, "error");
                        results.failed++;
                    }
                    results.total++;
                } catch (e) {
                    addLog("‚ùå Test 6 ERROR", "error");
                    results.failed++;
                    results.total++;
                }

                // Resumen
                addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                addLog("üìä RESUMEN DE TESTS DE SEGURIDAD", "info");
                addLog(`Total: ${results.total} tests`, "info");
                addLog(`‚úÖ Pasados: ${results.passed}`, "success");
                addLog(`‚ùå Fallidos: ${results.failed}`, results.failed > 0 ? "error" : "success");
                addLog(
                    `üìà Tasa de √©xito: ${((results.passed / results.total) * 100).toFixed(1)}%`,
                    results.failed === 0 ? "success" : "warning",
                );
                addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");

                if (results.failed === 0) {
                    addLog("üéâ ¬°TODOS LOS TESTS PASARON! Gatekeeper funcionando perfectamente", "success");
                } else {
                    addLog("‚ö†Ô∏è Algunos tests fallaron. Revisar configuraci√≥n de seguridad", "warning");
                }
            }

            async function getUserPermissions() {
                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                addLog("Consultando permisos del usuario...", "info");

                try {
                    const response = await fetch(`${API_URL}/api/v1/auth/permissions`, {
                        headers: { Authorization: `Bearer ${authToken}` },
                    });

                    if (response.ok) {
                        const data = await response.json();
                        addLog(`Usuario: ${data.username}`, "info");
                        addLog(`Rol: ${data.rol}`, "info");
                        addLog(`Permisos: ${data.permissions.join(", ")}`, "success");
                        addLog(
                            `Puede administrar: ${data.can_admin ? "S√≠" : "No"}`,
                            data.can_admin ? "success" : "warning",
                        );
                        addLog(
                            `Puede gestionar proyectos: ${data.can_manage_projects ? "S√≠" : "No"}`,
                            data.can_manage_projects ? "success" : "warning",
                        );
                    } else {
                        addLog("‚ùå Error al obtener permisos", "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            // ========== FUNCIONES DE CACH√â ==========

            async function checkCacheStats() {
                addLog("Consultando estad√≠sticas de cach√©...", "info");
                try {
                    const response = await fetch(`${API_URL}/cache/stats`);
                    const data = await response.json();

                    // Actualizar dashboard de cach√©
                    const available = data.available ? "‚úì Activo" : "‚úó Inactivo";
                    document.getElementById("cacheAvailable").textContent = available;
                    document.getElementById("cacheKeys").textContent = data.total_keys || 0;
                    document.getElementById("cacheHits").textContent = data.hits || 0;
                    document.getElementById("cacheMisses").textContent = data.misses || 0;
                    document.getElementById("cacheHitRate").textContent = data.hit_rate
                        ? data.hit_rate.toFixed(2) + "%"
                        : "0%";
                    document.getElementById("cacheMemory").textContent = data.used_memory_human || "N/A";

                    // Actualizar detalles en la pesta√±a de cach√©
                    document.getElementById("cacheStatusDetail").textContent = available;
                    document.getElementById("cacheKeysDetail").textContent = data.total_keys || 0;
                    document.getElementById("cacheHitsDetail").textContent = data.hits || 0;
                    document.getElementById("cacheMissesDetail").textContent = data.misses || 0;
                    document.getElementById("cacheHitRateDetail").textContent = data.hit_rate
                        ? data.hit_rate.toFixed(2) + "%"
                        : "0%";
                    document.getElementById("cacheMemoryDetail").textContent = data.used_memory_human || "N/A";

                    if (data.available) {
                        addLog(
                            `Redis activo - ${data.total_keys} claves, Hit Rate: ${data.hit_rate?.toFixed(2)}%`,
                            "success",
                        );
                        document.querySelectorAll("#cacheStatus .health-item, #cacheStatusDetail").forEach((item) => {
                            item.classList.remove("warning");
                            item.classList.add("success");
                        });
                    } else {
                        addLog("Redis no disponible", "warning");
                    }
                } catch (error) {
                    addLog(`Error al obtener estad√≠sticas de cach√©: ${error.message}`, "error");
                    document.getElementById("cacheAvailable").textContent = "‚úó Error";
                    document.getElementById("cacheStatusDetail").textContent = "‚úó Error";
                }
            }

            async function testCachePerformance() {
                addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEST DE RENDIMIENTO DE CACH√â ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");

                try {
                    // Limpiar cach√© primero (si hay datos)
                    addLog("Preparando test...", "info");
                    await sleep(500);

                    // Test 1: Primera consulta (Cache MISS esperado)
                    addLog("Test 1: Primera consulta a /proyectos (Cache MISS)...", "info");
                    let startTime = Date.now();
                    await fetch(`${API_URL}/api/v1/proyectos`);
                    let elapsed1 = Date.now() - startTime;
                    addLog(`‚è±Ô∏è Tiempo: ${elapsed1}ms (desde PostgreSQL)`, "warning");

                    await sleep(500);

                    // Test 2: Segunda consulta (Cache HIT esperado)
                    addLog("Test 2: Segunda consulta a /proyectos (Cache HIT)...", "info");
                    startTime = Date.now();
                    await fetch(`${API_URL}/api/v1/proyectos`);
                    let elapsed2 = Date.now() - startTime;
                    addLog(`‚ö° Tiempo: ${elapsed2}ms (desde Redis)`, "success");

                    await sleep(500);

                    // Test 3: Consulta individual (Cache MISS esperado)
                    addLog("Test 3: Consulta proyecto individual (Cache MISS)...", "info");
                    startTime = Date.now();
                    await fetch(`${API_URL}/api/v1/proyectos/1`);
                    let elapsed3 = Date.now() - startTime;
                    addLog(`‚è±Ô∏è Tiempo: ${elapsed3}ms (desde PostgreSQL)`, "warning");

                    await sleep(500);

                    // Test 4: Segunda consulta individual (Cache HIT esperado)
                    addLog("Test 4: Segunda consulta proyecto individual (Cache HIT)...", "info");
                    startTime = Date.now();
                    await fetch(`${API_URL}/api/v1/proyectos/1`);
                    let elapsed4 = Date.now() - startTime;
                    addLog(`‚ö° Tiempo: ${elapsed4}ms (desde Redis)`, "success");

                    // Resumen
                    const improvement1 = (((elapsed1 - elapsed2) / elapsed1) * 100).toFixed(1);
                    const improvement2 = (((elapsed3 - elapsed4) / elapsed3) * 100).toFixed(1);

                    addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESUMEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
                    addLog(`Lista: ${elapsed1}ms ‚Üí ${elapsed2}ms (${improvement1}% m√°s r√°pido)`, "success");
                    addLog(`Individual: ${elapsed3}ms ‚Üí ${elapsed4}ms (${improvement2}% m√°s r√°pido)`, "success");
                    addLog(
                        `Aceleraci√≥n promedio: ${((parseFloat(improvement1) + parseFloat(improvement2)) / 2).toFixed(1)}%`,
                        "success",
                    );

                    // Actualizar estad√≠sticas
                    await checkCacheStats();
                } catch (error) {
                    addLog(`Error en test de rendimiento: ${error.message}`, "error");
                }
            }

            async function demonstrateCache() {
                addLog("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEMOSTRACI√ìN CACHE-ASIDE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");

                try {
                    addLog("1Ô∏è‚É£ Consultando lista de proyectos (primera vez)...", "info");
                    await fetch(`${API_URL}/api/v1/proyectos`);
                    addLog("   Cache MISS esperado - Datos guardados en Redis", "warning");
                    await sleep(1000);

                    addLog("2Ô∏è‚É£ Consultando lista de proyectos (segunda vez)...", "info");
                    await fetch(`${API_URL}/api/v1/proyectos`);
                    addLog("   Cache HIT esperado - Datos desde Redis ‚ö°", "success");
                    await sleep(1000);

                    addLog("3Ô∏è‚É£ Consultando tareas (primera vez)...", "info");
                    await fetch(`${API_URL}/api/v1/tareas`);
                    addLog("   Cache MISS esperado - Datos guardados en Redis", "warning");
                    await sleep(1000);

                    addLog("4Ô∏è‚É£ Consultando tareas (segunda vez)...", "info");
                    await fetch(`${API_URL}/api/v1/tareas`);
                    addLog("   Cache HIT esperado - Datos desde Redis ‚ö°", "success");
                    await sleep(1000);

                    addLog("‚úÖ Demostraci√≥n completada", "success");
                    addLog("üí° Revisa los logs del servidor para ver los HIT/MISS reales", "info");

                    // Actualizar estad√≠sticas
                    await checkCacheStats();
                } catch (error) {
                    addLog(`Error en demostraci√≥n: ${error.message}`, "error");
                }
            }

            window.addEventListener("load", () => {
                addLog("Interfaz cargada correctamente", "success");
                addLog("üõ°Ô∏è Patrones de seguridad: Gatekeeper + Federated Identity activados", "info");
                addLog('Haz clic en "Ejecutar Demo Completa"', "info");
                checkHealth();
                updateStats();
                checkCacheStats();
                updateAuthState(); // Restaurar estado de autenticaci√≥n si existe
            });
            // ====================================
            // QUEUE-BASED LOAD LEVELING FUNCTIONS
            // ====================================

            let activeJobs = [];
            let jobsCreatedCount = 0;

            async function updateQueueStats() {
                if (!authToken) {
                    // Silencioso si no hay token, solo actualiza UI con valores por defecto
                    return;
                }
                
                try {
                    addLog("Consultando estad√≠sticas de la cola...", "info");

                    const response = await fetch(`${API_URL}/api/v1/tareas/queue/stats`, {
                        headers: { "Authorization": `Bearer ${authToken}` }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        document.getElementById("queueSize").textContent = data.data.queue_size;
                        document.getElementById("queueRedisStatus").textContent = data.data.redis_available
                            ? "‚úÖ Conectado"
                            : "‚ùå Desconectado";
                        document.getElementById("jobsCreated").textContent = jobsCreatedCount;

                        addLog(`Cola: ${data.data.queue_size} mensajes pendientes`, "success");
                    } else {
                        addLog("Error al obtener estad√≠sticas de la cola", "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                    document.getElementById("queueRedisStatus").textContent = "‚ùå Error";
                }
            }

            async function createAsyncTask() {
                const title = document.getElementById("queueTaskTitle").value || "Tarea de prueba Load Leveling";
                const priority = document.getElementById("queueTaskPriority").value;

                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                const startTime = performance.now();

                try {
                    addLog(`Creando tarea as√≠ncrona: "${title}"...`, "info");

                    const response = await fetch(`${API_URL}/api/v1/tareas/`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            titulo: title,
                            descripcion: `Tarea creada desde demo web a las ${new Date().toLocaleTimeString()}`,
                            proyecto_id: 1,
                            prioridad: priority,
                            estado: "pendiente",
                        }),
                    });

                    const endTime = performance.now();
                    const responseTime = Math.round(endTime - startTime);

                    const data = await response.json();

                    if (response.status === 202) {
                        document.getElementById("responseRate").textContent = `${responseTime}ms`;
                        document.getElementById("jobIdInput").value = data.job_id;

                        jobsCreatedCount++;
                        document.getElementById("jobsCreated").textContent = jobsCreatedCount;

                        activeJobs.unshift({
                            job_id: data.job_id,
                            title: title,
                            status: data.status,
                            created_at: new Date().toLocaleTimeString(),
                            response_time: responseTime,
                        });

                        updateActiveJobsList();

                        addLog(`‚úÖ Tarea encolada en ${responseTime}ms`, "success");
                        addLog(`Job ID: ${data.job_id}`, "info");
                        addLog(`Cola: ${data.queue_position || "N/A"} pendientes`, "info");

                        // Auto-monitorear el job
                        setTimeout(() => monitorJob(data.job_id), 2000);

                        await updateQueueStats();
                    } else {
                        addLog(`Error: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function checkJobStatus() {
                const jobId = document.getElementById("jobIdInput").value;

                if (!jobId) {
                    addLog("Por favor ingresa un Job ID", "warning");
                    return;
                }

                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                try {
                    addLog(`Consultando estado del job ${jobId.substring(0, 8)}...`, "info");

                    const response = await fetch(`${API_URL}/api/v1/tareas/jobs/${jobId}`, {
                        headers: { "Authorization": `Bearer ${authToken}` }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        addLog(`Estado: ${data.status}`, data.status === "completed" ? "success" : "info");
                        addLog(`Mensaje: ${data.message}`, "info");

                        if (data.updated_at) {
                            addLog(`Actualizado: ${data.updated_at}`, "info");
                        }

                        // Actualizar en la lista
                        const job = activeJobs.find((j) => j.job_id === jobId);
                        if (job) {
                            job.status = data.status;
                            updateActiveJobsList();
                        }
                    } else {
                        addLog(`Error: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function getJobResult() {
                const jobId = document.getElementById("jobIdInput").value;

                if (!jobId) {
                    addLog("Por favor ingresa un Job ID", "warning");
                    return;
                }

                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                try {
                    addLog(`Obteniendo resultado del job ${jobId.substring(0, 8)}...`, "info");

                    const response = await fetch(`${API_URL}/api/v1/tareas/jobs/${jobId}/result`, {
                        headers: { "Authorization": `Bearer ${authToken}` }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        if (data.status === "completed" && data.result) {
                            addLog(`‚úÖ Tarea creada exitosamente!`, "success");
                            addLog(`ID de Tarea: ${data.result.id}`, "info");
                            addLog(`T√≠tulo: ${data.result.titulo}`, "info");
                            addLog(`Estado: ${data.result.estado}`, "info");
                            addLog(`Prioridad: ${data.result.prioridad}`, "info");

                            await listTasks();
                        } else if (data.status === "failed") {
                            addLog(`‚ùå Job fall√≥: ${data.error}`, "error");
                        } else {
                            addLog(`Job a√∫n est√° en estado: ${data.status}`, "warning");
                        }
                    } else {
                        addLog(`Error: ${data.detail}`, "error");
                    }
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function createConcurrentTasks() {
                const count = parseInt(document.getElementById("concurrentTasks").value) || 10;

                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                addLog(`üî• Iniciando creaci√≥n concurrente de ${count} tareas...`, "info");

                const startTime = performance.now();
                const promises = [];

                for (let i = 1; i <= count; i++) {
                    const promise = fetch(`${API_URL}/api/v1/tareas/`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            titulo: `Tarea Concurrente ${i}/${count}`,
                            descripcion: `Tarea de prueba de carga - Batch ${new Date().getTime()}`,
                            proyecto_id: 1,
                            prioridad: ["alta", "media", "baja"][i % 3],
                            estado: "pendiente",
                        }),
                    }).then((r) => r.json());

                    promises.push(promise);
                }

                try {
                    const results = await Promise.all(promises);
                    const endTime = performance.now();
                    const totalTime = endTime - startTime;

                    const successCount = results.filter((r) => r.job_id).length;
                    const avgResponseTime = Math.round(totalTime / count);
                    const throughput = (count / (totalTime / 1000)).toFixed(2);

                    addLog(`‚úÖ ${successCount}/${count} tareas encoladas exitosamente`, "success");
                    addLog(`‚è±Ô∏è Tiempo total: ${totalTime.toFixed(0)}ms`, "info");
                    addLog(`‚ö° Tiempo promedio: ${avgResponseTime}ms por tarea`, "info");
                    addLog(`üöÄ Throughput: ${throughput} requests/segundo`, "success");

                    // Agregar jobs a la lista
                    results.forEach((r, i) => {
                        if (r.job_id) {
                            activeJobs.unshift({
                                job_id: r.job_id,
                                title: `Tarea Concurrente ${i + 1}`,
                                status: r.status,
                                created_at: new Date().toLocaleTimeString(),
                                response_time: avgResponseTime,
                            });
                            jobsCreatedCount++;
                        }
                    });

                    // Mantener solo los √∫ltimos 20 jobs
                    activeJobs = activeJobs.slice(0, 20);
                    document.getElementById("jobsCreated").textContent = jobsCreatedCount;

                    updateActiveJobsList();
                    await updateQueueStats();

                    addLog("üí° Los jobs se est√°n procesando en background", "info");
                    addLog('Usa "Monitorear Jobs Activos" para ver el progreso', "info");
                } catch (error) {
                    addLog(`Error: ${error.message}`, "error");
                }
            }

            async function monitorActiveJobs() {
                if (activeJobs.length === 0) {
                    addLog("No hay jobs activos para monitorear", "warning");
                    return;
                }

                if (!authToken) {
                    addLog("‚ö†Ô∏è Debes iniciar sesi√≥n primero", "warning");
                    return;
                }

                addLog(`Monitoreando ${activeJobs.length} jobs...`, "info");

                let completedCount = 0;
                let failedCount = 0;
                let pendingCount = 0;

                for (const job of activeJobs.slice(0, 10)) {
                    try {
                        const response = await fetch(`${API_URL}/api/v1/tareas/jobs/${job.job_id}`, {
                            headers: { "Authorization": `Bearer ${authToken}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            job.status = data.status;

                            if (data.status === "completed") completedCount++;
                            else if (data.status === "failed") failedCount++;
                            else pendingCount++;
                        }
                    } catch (error) {
                        console.error(`Error monitoring job ${job.job_id}:`, error);
                    }
                }

                updateActiveJobsList();

                addLog(`üìä Resultados:`, "info");
                addLog(`‚úÖ Completados: ${completedCount}`, "success");
                addLog(`‚è≥ Pendientes/Procesando: ${pendingCount}`, "info");
                if (failedCount > 0) {
                    addLog(`‚ùå Fallidos: ${failedCount}`, "error");
                }

                await updateQueueStats();
            }

            async function monitorJob(jobId) {
                if (!authToken) {
                    return; // Silencioso si no hay token
                }
                
                let attempts = 0;
                const maxAttempts = 10;

                const checkStatus = async () => {
                    try {
                        const response = await fetch(`${API_URL}/api/v1/tareas/jobs/${jobId}`, {
                            headers: { "Authorization": `Bearer ${authToken}` }
                        });
                        if (response.ok) {
                            const data = await response.json();

                            // Actualizar job en la lista
                            const job = activeJobs.find((j) => j.job_id === jobId);
                            if (job) {
                                job.status = data.status;
                                updateActiveJobsList();
                            }

                            if (data.status === "completed") {
                                addLog(`‚úÖ Job ${jobId.substring(0, 8)}... completado!`, "success");
                                return true;
                            } else if (data.status === "failed") {
                                addLog(`‚ùå Job ${jobId.substring(0, 8)}... fall√≥`, "error");
                                return true;
                            }
                        }
                    } catch (error) {
                        console.error("Error monitoring job:", error);
                    }

                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, 2000);
                    }
                    return false;
                };

                checkStatus();
            }

            function updateActiveJobsList() {
                const container = document.getElementById("activeJobsList");

                if (activeJobs.length === 0) {
                    container.innerHTML =
                        '<p style="color: var(--gray-500); text-align: center;">No hay jobs recientes</p>';
                    return;
                }

                const statusColors = {
                    pending: "var(--warning)",
                    processing: "var(--info)",
                    completed: "var(--success)",
                    failed: "var(--danger)",
                };

                const statusEmojis = {
                    pending: "‚è≥",
                    processing: "üîÑ",
                    completed: "‚úÖ",
                    failed: "‚ùå",
                };

                container.innerHTML = activeJobs
                    .map(
                        (job) => `
                <div style="padding: 12px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">
                            ${job.title}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--gray-600); font-family: monospace;">
                            Job: ${job.job_id.substring(0, 16)}...
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: ${statusColors[job.status] || "var(--gray-400)"}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;">
                            ${statusEmojis[job.status] || "‚ùì"} ${job.status.toUpperCase()}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">
                            ${job.created_at} ‚Ä¢ ${job.response_time}ms
                        </div>
                    </div>
                </div>
            `,
                    )
                    .join("");
            }

            // Auto-actualizar estad√≠sticas cada 10 segundos
            setInterval(() => {
                if (document.getElementById("queue").classList.contains("active")) {
                    updateQueueStats();
                }
            }, 10000);

            // Inicializar cuando se carga la p√°gina
            window.addEventListener("load", () => {
                updateQueueStats();
            });
        </script>
    </body>
</html>
